"use strict";var _createClass=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var DBHelper=function(){function a(){_classCallCheck(this,a)}return _createClass(a,null,[{key:"checkStatus",value:function(e){return 200===e.status?Promise.resolve(e):Promise.reject(new Error("Request has failed. Return status: "+e.statusText))}},{key:"json",value:function(e){return e.json()}},{key:"openDB",value:function(){return idb.open("restaurantsDB",3,function(e){switch(e.oldVersion){case 0:console.log("Creating IDB"),e.createObjectStore("restaurants",{keyPath:"id"}).createIndex("by-id","id");case 1:console.log("Upgrading to DB v2"),e.createObjectStore("reviews",{keyPath:"id"}).createIndex("restaurant","restaurant_id");e.createObjectStore("offline_reviews",{keyPath:"updatedAt"});case 2:console.log("Upgrading to DB v3"),e.createObjectStore("offline_favourites",{keyPath:"restaurant_id"}).createIndex("by-restaurant","restaurant_id")}})}},{key:"getRestaurantsFromDB",value:function(){return a.openDB().then(function(e){if(console.log("Getting Restaurants From DB"),e)return e.transaction("restaurants").objectStore("restaurants").getAll()})}},{key:"getRestaurantsFromAPI",value:function(){return console.log("Getting Restaurants From API"),fetch(a.DATABASE_URL).then(a.checkStatus).then(a.json).then(function(e){return a.saveRestaurants(e),e})}},{key:"saveRestaurants",value:function(r){return a.openDB().then(function(e){if(e){var t=e.transaction("restaurants","readwrite"),n=t.objectStore("restaurants");return r.forEach(function(e){n.put(e)}),t.complete}}).then(function(){console.log("Restaurants Saved")})}},{key:"updateRestaurant",value:function(t){return a.openDB().then(function(e){if(e)return e.transaction("restaurants","readwrite").objectStore("restaurants").put(t)}).then(function(){console.log("Restaurant Updated")})}},{key:"fetchRestaurants",value:function(t){return a.getRestaurantsFromDB().then(function(e){return e.length?Promise.resolve(e):a.getRestaurantsFromAPI()}).then(function(e){t(null,e)}).catch(function(e){t(e,null)})}},{key:"fetchRestaurantById",value:function(r,o){a.fetchRestaurants(function(e,t){if(e)o(e,null);else{var n=t.find(function(e){return e.id==r});n?o(null,n):o("Restaurant does not exist",null)}})}},{key:"fetchRestaurantByCuisine",value:function(r,o){a.fetchRestaurants(function(e,t){if(e)o(e,null);else{var n=t.filter(function(e){return e.cuisine_type==r});o(null,n)}})}},{key:"fetchRestaurantByNeighborhood",value:function(r,o){a.fetchRestaurants(function(e,t){if(e)o(e,null);else{var n=t.filter(function(e){return e.neighborhood==r});o(null,n)}})}},{key:"fetchRestaurantByCuisineAndNeighborhood",value:function(r,o,i){a.fetchRestaurants(function(e,t){if(e)i(e,null);else{var n=t;"all"!=r&&(n=n.filter(function(e){return e.cuisine_type==r})),"all"!=o&&(n=n.filter(function(e){return e.neighborhood==o})),i(null,n)}})}},{key:"fetchNeighborhoods",value:function(o){a.fetchRestaurants(function(e,n){if(e)o(e,null);else{var r=n.map(function(e,t){return n[t].neighborhood}),t=r.filter(function(e,t){return r.indexOf(e)==t});o(null,t)}}),a.fetchReviews(function(e,t){e?o(e,null):console.log("dbhelper fetchReviews !error()")})}},{key:"fetchCuisines",value:function(o){a.fetchRestaurants(function(e,n){if(e)o(e,null);else{var r=n.map(function(e,t){return n[t].cuisine_type}),t=r.filter(function(e,t){return r.indexOf(e)==t});o(null,t)}})}},{key:"urlForRestaurant",value:function(e){return"./restaurant.html?id="+e.id}},{key:"imageUrlForRestaurant",value:function(e,t){if(e.photograph)return"/buildTool/img/"+e.id+".jpg"}},{key:"mapMarkerForRestaurant",value:function(e,t){return new google.maps.Marker({position:e.latlng,title:e.name,url:a.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP})}},{key:"getReviewsFromDB",value:function(){return a.openDB().then(function(e){if(e){e.transaction("reviews").objectStore("reviews").index("restaurant");return""}})}},{key:"getReviewsFromAPI",value:function(){return fetch(a.REVIEWS_URL).then(a.checkStatus).then(a.json).then(function(e){return a.saveReviews(e),e})}},{key:"checkOfflineReviews",value:function(){return new Promise(function(t,n){a.openDB().then(function(e){e&&e.transaction("offline_reviews").objectStore("offline_reviews").getAll().then(function(e){return t(e)}).catch(function(e){n(e)})})})}},{key:"saveReviews",value:function(r){return a.openDB().then(function(e){if(e){var t=e.transaction("reviews","readwrite"),n=t.objectStore("reviews");return r.forEach(function(e){n.put(e)}),t.complete}}).then(function(){console.log("Reviews saved")})}},{key:"saveReview",value:function(n){return a.openDB().then(function(e){if(e){var t=e.transaction("reviews","readwrite");return t.objectStore("reviews").put(n),t.complete}}).then(function(){console.log("Review saved");var e=new CustomEvent("update_reviews_list",{detail:{restaurant_id:n.restaurant_id}});document.dispatchEvent(e)})}},{key:"saveReviewOffline",value:function(n){return a.openDB().then(function(e){if(e){var t=e.transaction("offline_reviews","readwrite");return t.objectStore("offline_reviews").put(n),t.complete}}).then(function(){console.log("Review saved offline")})}},{key:"sendReview",value:function(t){return fetch(a.REVIEWS_URL,{body:JSON.stringify(t),headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST"}).then(function(e){e.json().then(function(e){e.restaurant_id=parseInt(getParameterByName("id")),e.updatedAt=(new Date).getTime(),e.createdAt=(new Date).getTime(),a.saveReview(e)})}).catch(function(e){t.restaurant_id=parseInt(getParameterByName("id")),t.updatedAt=(new Date).getTime(),t.createdAt=(new Date).getTime(),a.saveReviewOffline(t)})}},{key:"removeOfflineReview",value:function(e){return new Promise(function(e,t){a.openDB().then(function(e){if(e){var t=e.transaction("offline_reviews","readwrite"),n=[];t.objectStore("offline_reviews").iterateCursor(function(e){e&&(a.sendReview(e.value),n.push(e.value),e.delete(),e.continue())}).then(function(){console.log("Item deleted")}).then(function(){return t.complete})}})})}},{key:"fetchReviews",value:function(t){return a.getReviewsFromDB().then(function(e){return e.length?Promise.resolve(e):a.getReviewsFromAPI()}).then(function(e){t(null,e)}).catch(function(e){t(e,null)})}},{key:"fetchReviewByRestaurant",value:function(t,e){return a.openDB().then(function(e){return e.transaction("reviews").objectStore("reviews").index("restaurant").getAll(t)}).then(function(e){return e})}},{key:"saveFavouriteOffline",value:function(e,t){var n=[];return n.restaurant_id=parseInt(e),n.is_favorite=t,a.openDB().then(function(e){if(e){var t=e.transaction("offline_favourites","readwrite");return t.objectStore("offline_favourites").put(n),t.complete}}).then(function(){console.log("Favourite saved offline")})}},{key:"sendFavourite",value:function(t,n){return fetch(a.DATABASE_URL+"/"+t+"/?is_favorite="+n,{method:"PUT"}).then(function(e){e.json().then(function(e){a.updateRestaurant(e)})}).catch(function(e){a.saveFavouriteOffline(t,n)})}},{key:"checkOfflineFavourites",value:function(){return new Promise(function(t,n){a.openDB().then(function(e){e&&e.transaction("offline_favourites").objectStore("offline_favourites").getAll().then(function(e){return t(e)}).catch(function(e){n(e)})})})}},{key:"removeOfflineFavourite",value:function(e){return new Promise(function(e,t){a.openDB().then(function(e){if(e){var t=e.transaction("offline_favourites","readwrite"),n=[];t.objectStore("offline_favourites").iterateCursor(function(e){e&&(a.sendFavourite(e.value.restaurant_id,e.value.is_favorite),n.push(e.value),e.delete(),e.continue())}).then(function(){console.log("Favourite deleted")}).then(function(){return t.complete})}})})}},{key:"DATABASE_URL",get:function(){return"http://localhost:1337/restaurants"}},{key:"REVIEWS_URL",get:function(){return"http://localhost:1337/reviews"}}]),a}();
//# sourceMappingURL=dbhelper.js.map
